[gcode_arcs]
[exclude_object]

[force_move]
enable_force_move: True

[include prusawire/mainsail.cfg]

#[mcu rpi]
#serial: /tmp/klipper_host_mcu

#[temperature_sensor Raspberry_Pi]
#sensor_type: temperature_host

## Uncomment for your configuration

#########################
#### MAINBOARDS

##### Einsy RAMbo
#[include prusawire/mainboards/einsy_rambo.cfg]
#
#[mcu]
# serial: /dev/serial/by-id/usb-Prusa_Research__prusa3d.com__Original_Prusa_i3_MK3_xxxxxxx

##### BTT SKR Mini E3
#[include prusawire/mainboards/btt_skr_mini_e3_v3.cfg]
#
#[mcu]
# serial: /dev/serial/by-id/usb-Klipper_stm32_xxxxxxx

#########################
#### TOOLHEAD BOARDS

##### LDO Nitehawk SB
#[include prusawire/toolboards/ldo_nitehawk_sb.cfg]
#
#[mcu nitehawk]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_xxxxxxx

##### BTT SB2209 USB
#[include prusawire/toolboards/btt_sb2209_usb.cfg
#
#[mcu sb2209]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_xxxxxxx

#########################
#### PROBES

##### SuperPINDA on LDO Nitehawk SB
#[include prusawire/probes/super_pinda__ldo_nitehawk_sb.cfg]

##### E3D PZ Probe on LDO Nitehawk SB
#[include prusawire/probes/e3d_pz_probe__ldo_nitehawk_sb.cfg]

##### SuperPINDA on BTT SB2209 USB
#[include prusawire/probes/super_pinda__btt_sb2209_usb.cfg

##### E3D PZ Probe on BTT SB2209 USB
#[include prusawire/probes/e3d_pz_probe__btt_sb2209_usb.cfg]

#########################
#### FILAMENT SENSOR

##### LDO Nitehawk SB
#[include prusawire/filament_sensors/ldo_nitehawk_sb.cfg]

##### BTT SB2209 USB
#[include prusawire/filament_sensors/btt_sb2209_usb.cfg]

# For BTT Pi TFT and HDMI 5, please check back soon

#########################
#### LCD SCREENS

##### Prusa MK3 LCD
#[include prusawire/screens/prusa_mk3_einsy_rambo.cfg]

# For BTT Pi TFT and HDMI 5, please check back soon

#########################

[printer]
kinematics: corexz
max_velocity: 350
max_accel: 4000
max_z_velocity: 300
max_z_accel: 2000
square_corner_velocity: 12.0

[input_shaper]
shaper_type_x: mzv
shaper_freq_x: 38.6
damping_ratio_x: 0.037
shaper_freq_y: 69.8
shaper_type_y: 3hump_ei
damping_ratio_y: 0.053

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customize for your slicer of choice
gcode:
    G28                            ; home all axes
    G90                            ; absolute positioning
    G1 Z20 F3000                   ; move nozzle away from bed

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customize for your slicer of choice
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-4.0 F3600                 ; retract filament
    G91                            ; relative positioning

#   Get Boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

#   Check end position to determine safe direction to move
    {% if printer.toolhead.position.x < (max_x - 20) %}
    {% set x_safe = 20.0 %}
    {% else %}
    {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
    {% set y_safe = 20.0 %}
    {% else %}
    {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 2) %}
    {% set z_safe = 2.0 %}
    {% else %}
    {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}

    G0 Z{z_safe} F3600             ; move nozzle up
    G0 X{x_safe} Y{y_safe} F20000  ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G90                            ; absolute positioning
    G0 X60 Y{max_y} F3600          ; park nozzle at rear

[gcode_macro CHOME]
description: Homes XYZ axis only if printer is in a non-homed state
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
    {% endif %}

[gcode_macro UNLOAD_FILAMENT]
description: Unloads filament from toolhead
gcode:
    {% set EXTRUDER_TEMP = params.TEMP|default(230)|int %}
    CHOME
    G91                         ; relative positioning
    G1 Z20                      ; move nozzle upwards
    FRONT                       ; move the toolhead to the front
    LOGO_PENDING
    M109 S{EXTRUDER_TEMP}       ; heat up the hotend
    LOGO_READY
    M83                         ; set extruder to relative mode
    G1 E-8 F1800                ; quickly retract a small amount to elimate stringing
    G4 P200                     ; pause for a short amount of time
    G1 E-50 F300                ; retract slowly the rest of the way
    G1 E-20 F300
    M400                        ; wait for moves to finish
    M117 Unload Complete!
    LOGO_OFF

[gcode_macro LOAD_FILAMENT]
description: Loads new filament into toolhead
gcode:
    {% set EXTRUDER_TEMP = params.TEMP|default(230)|int %}
    FRONT                       ; move the toolhead to the front
    LOGO_PENDING
    M109 S{EXTRUDER_TEMP}       ; heat up the hotend
    LOGO_READY
    M83                         ; set extruder to relative mode
    G1 E50 F300                 ; extrude slowlyL
    G1 E50 F300
    M400                        ; wait for moves to finish
    M117 Load Complete!
    LOGO_OFF

[gcode_macro CENTER]
description: Moves the toolhead to the center
gcode:
    CHOME
    {% set x_center = printer.toolhead.axis_maximum.x|float / 2.0 %}
    {% set y_center = printer.toolhead.axis_maximum.y|float / 2.0 %}
    G90
    G1 X{x_center} Y{x_center} F7800

[gcode_macro FRONT]
description: Moves the toolhead to the front
gcode:
    CHOME
    {% set x_center = printer.toolhead.axis_maximum.x|float / 2.0 %}
    {% set y_center = printer.toolhead.axis_maximum.y|float / 2.0 %}
    G90
    G1 X{x_center} Y10 F7800

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 0.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.00
#*# pid_ki = 4.8
#*# pid_kd = 32.6
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 126.13
#*# pid_ki = 4.30
#*# pid_kd = 924.76
